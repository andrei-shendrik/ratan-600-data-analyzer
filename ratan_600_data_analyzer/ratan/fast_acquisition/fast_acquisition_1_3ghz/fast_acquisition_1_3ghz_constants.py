from datetime import timezone, timedelta
import numpy as np

CHUNK_LENGTH = 0x80
POLARIZATION_MASK = 0b00000000000010000000000000000000

dt = np.dtype([
 ('cnt', '<u4'),
 ('avg_kurt', '<u4'),
 ('state', '<u4'),
 ('channel', '<u4'),
 ('data', '<u8', 0x80)
])

TIMEZONE = timezone(timedelta(hours=3))
UTC = timezone(timedelta(hours=0))

COLORSCALE = "turbo"
GRAPH_COLORSCALE = "Rainbow"

FIG_MARGINS = {"l": 100, "r": 20, "t": 40, "b": 60}

IMAGE_CONFIG = {
    "toImageButtonOptions": {
        "format": "svg",  # one of png, svg, jpeg, webp
        "width": 1024,
        "height": 620,
        "scale": 1  # Multiply title/legend/axis/canvas sizes by this factor
    }
}

FREQ_MIN = 1000
FREQ_MAX = 3000

ARCSEC_MIN = -1500
ARCSEC_MAX = 1500

KURT_THRESHOLD = 224

GENERATOR_BIT = 20
SAMPLES_PER_SECOND = 2_000_000_000 / 16384 / 1024
N_COMPONENTS = 12
TIME_REDUCTION_FACTOR = 32

OBS_TIME_DELAY = 1000

FITS_KWARGS = {
    "hovertemplate": f"(%{{x:.0f}}, %{{y:.0f}}) arcsec",
    "hoverlabel": {"namelength": 0},
}

AIA_BASEURL = "http://jsoc.stanford.edu/data/aia/synoptic/"
AIA_BASEURL_RECENT = "http://jsoc.stanford.edu/data/aia/synoptic/nrt/"

HMI_BASEURL = "http://jsoc.stanford.edu/data/hmi/fits/"

SPECTROGRAM = "Спектрограмма"
WATERFALL = "Водопад"
SURFACE = "3D"

FILTER_BANDS = [
    [1716, 2045],
    [2099, 2213],
    [2409, 2702],
    [2960, 3000]
]

FLUX_DM = np.array(
    [7.17848669193389, 7.18816793813219, 7.19778006140503, 7.207322875133, 7.21679619361387, 7.2261998320626,
     7.2355336066113, 7.2447973343093, 7.25399083312308, 7.26311392193634, 7.27216642054992, 7.28114814968186,
     7.29005893096739, 7.29889858695891, 7.30766694112601, 7.31636381785544, 7.32498904245116, 7.3335424411343,
     7.34202384104317, 7.35043307023325, 7.35876995767724, 7.36703433326498, 7.3752260278035, 7.38334487301703,
     7.39139070154697, 7.39936334695189, 7.40726264370757, 7.41508842720696, 7.42284053376016, 7.4305188005945,
     7.43812306585447, 7.44565316860173, 7.45310894881514, 7.46049024739073, 7.46779690614173, 7.47502876779852,
     7.48218567600869, 7.489267475337, 7.49627401126538, 7.50320513019299, 7.51006067943609, 7.5168405072282,
     7.52354446271997, 7.53017239597926, 7.53672415799111, 7.54319960065773, 7.5495985767985, 7.55592094015001,
     7.56216654536601, 7.56833524801746, 7.57442690459246, 7.58044137249632, 7.58860963391539, 7.59696122413556,
     7.60524878311508, 7.6134721755546, 7.6216312669191, 7.62972592343783, 7.63775601210436, 7.64572140067657,
     7.65362195767662, 7.66145755239098, 7.66922805487043, 7.67693333593004, 7.68457326714916, 7.6921477208715,
     7.69965657020502, 7.707099689022, 7.71447695195901, 7.72178823441694, 7.72903341256096, 7.73621236332056,
     7.74332496438951, 7.7503710942259, 7.75735063205212, 7.76426345785484, 7.77110945238506, 7.77788849715806,
     7.78460047445344, 7.79124526731507, 7.79782275955116, 7.80433283573418, 7.81077538120094, 7.81715028205254,
     7.82345742515434, 7.82969669813608, 7.83586798939172, 7.84197118807957, 7.84800618412224, 7.85397286820661,
     7.8598711317839, 7.8657008670696, 7.87146196704351, 7.87715432544975, 7.88277783679671, 7.8883323963571,
     7.89381790016793, 7.8992342450305, 7.90458132851043, 7.90985904893762, 7.91506730540629, 7.92020599777495,
     7.92527502666641, 7.93201292607298, 7.93912504141537, 7.94617766238447, 7.95317069095521, 7.96010402974921,
     7.96697758203487, 7.97379125172729, 7.98054494338829, 7.98723856222647, 7.99387201409711, 8.00044520550224,
     8.00695804359063, 8.01341043615779, 8.01980229164593, 8.02613351914401, 8.03240402838774, 8.03861372975952,
     8.04476253428853, 8.05085035365063, 8.05687710016846, 8.06284268681136, 8.06874702719541, 8.07459003558342,
     8.08037162688495, 8.08609171665627, 8.09175022110038, 8.09734705706703, 8.10288214205269, 8.10835539420057,
     8.11376673230058, 8.11911607578942, 8.12440334475047, 8.12962845991386, 8.13479134265646, 8.13989191500187,
     8.14493009962039, 8.1499058198291, 8.15481899959179, 8.15966956351896, 8.16445743686788, 8.16918254554254,
     8.17384481609363, 8.17844417571863, 8.18298055226169, 8.18745387421373, 8.19186407071241, 8.19621107154208,
     8.20049480713385, 8.20471520856558, 8.20887220756181, 8.21296573649386, 8.21833764647166, 8.22422796600233,
     8.23006273589637, 8.23584188623918, 8.24156534767049, 8.24723305138434, 8.25284492912908, 8.2584009132074,
     8.26390093647629, 8.26934493234706, 8.27473283478534, 8.28006457831107, 8.28534009799852, 8.29055932947626,
     8.29572220892721, 8.30082867308856, 8.30587865925187, 8.31087210526297, 8.31580894952203, 8.32068913098354,
     8.3255125891563, 8.33027926410344, 8.33498909644237, 8.33964202734488, 8.34423799853701, 8.34877695229917,
     8.35325883146607, 8.35768357942671, 8.36205114012446, 8.36636145805696, 8.37061447827619, 8.37481014638844,
     8.37894840855434, 8.3830292114888, 8.38705250246106, 8.3910182292947, 8.3949263403676, 8.39877678461195,
     8.40256951151427, 8.40630447111538, 8.40998161401045, 8.41360089134893, 8.41716225483462, 8.42066565672561,
     8.42411104983433, 8.42749838752751, 8.43082762372621, 8.43409871290579, 8.43731161009595, 8.44046627088069,
     8.44356265139834, 8.44761845905403, 8.45229945495294, 8.45692835417888, 8.46150510836745, 8.46602966963468,
     8.47050199057701, 8.47492202427135, 8.479289724275, 8.48360504462573, 8.48786793984172, 8.4920783649216,
     8.49623627534442, 8.50034162706966, 8.50439437653725, 8.50839448066754, 8.51234189686132, 8.5162365829998,
     8.52007849744465, 8.52386759903794, 8.52760384710219, 8.53128720144035, 8.53491762233582, 8.5384950705524,
     8.54201950733434, 8.54549089440634, 8.54890919397351, 8.55227436872138, 8.55558638181597, 8.55884519690366,
     8.56205077811132, 8.56520309004622, 8.56830209779608, 8.57134776692905, 8.57434006349371, 8.57727895401906,
     8.58016440551457, 8.58299638547011, 8.58577486185599, 8.58849980312295, 8.59117117820218, 8.59378895650529,
     8.59635310792432, 8.59886360283176, 8.6013204120805, 8.6037235070039, 8.60607285941573, 8.6083684416102,
     8.61061022636197, 8.61279818692608, 8.61493229703807, 8.61701253091388, 8.61979250233169, 8.62327587164692,
     8.62671019740603, 8.63009544798796, 8.63343159219197, 8.63671859923772, 8.63995643876523, 8.6431450808349,
     8.6462844959275, 8.64937465494417, 8.6524155292064, 8.65540709045608, 8.65834931085544, 8.66124216298712,
     8.6640856198541, 8.66687965487974, 8.66962424190776, 8.67231935520227, 8.67496496944773, 8.677561059749,
     8.68010760163126, 8.68260457104012, 8.68505194434153, 8.68744969832179, 8.68979781018761, 8.69209625756605,
     8.69434501850455, 8.6965440714709, 8.69869339535329, 8.70079296946025, 8.70284277352071, 8.70484278768394,
     8.70679299251962, 8.70869336901775, 8.71054389858875, 8.71234456306337, 8.71409534469276, 8.71579622614843,
     8.71744719052225, 8.71904822132647, 8.72059930249372, 8.72210041837698, 8.72355155374963, 8.72495269380537,
     8.72630382415833, 8.72760493084297, 8.72885600031413, 8.73005701944704, 8.73120797553726, 8.73230885630076,
     8.73335964987386, 8.73227025380041, 8.7279863927714, 8.72363927701623, 8.71922894056408, 8.71475541808627,
     8.71021874489629, 8.70561895694979, 8.70095609084457, 8.69623018382057, 8.69144127375993, 8.68658939918692,
     8.68167459926795, 8.67669691381163, 8.67165638326868, 8.66655304873203, 8.66138695193673, 8.65615813525999,
     8.65086664172119, 8.64551251498185, 8.64009579934569, 8.63461653975852, 8.62907478180837, 8.6234705717254,
     8.61780395638191, 8.61207498329238, 8.60628370061347, 8.60043015714394, 8.59451440232475, 8.58853648623901,
     8.58249645961197, 8.57639437381107, 8.57023028084587, 8.56400423336811, 8.55771628467168, 8.55136648869265,
     8.5449549000092, 8.5384815738417, 8.53194656605269, 8.52534993314683, 8.51869173227096, 8.51197202121408,
     8.50519085840734, 8.49834830292405, 8.49144441447968, 8.48447925343184, 8.47745288078032, 8.47036535816705,
     8.46321674787614, 8.45600711283384, 8.44873651660854, 8.44140502341084, 8.43435653857651, 8.42805008848884,
     8.42168370095747, 8.41525742076499, 8.40877129326481, 8.40222536438115, 8.39561968060911, 8.38895428901459,
     8.38222923723432, 8.37544457347588, 8.36860034651767, 8.36169660570893, 8.35473340096972, 8.34771078279095,
     8.34062880223436, 8.33348751093249, 8.32628696108877, 8.31902720547742, 8.31170829744349, 8.30433029090289,
     8.29689324034235, 8.28939720081942, 8.28184222796249, 8.2742283779708, 8.2665557076144, 8.25882427423417,
     8.25103413574185, 8.24318535061999, 8.23527797792197, 8.22731207727202, 8.21928770886518, 8.21120493346735,
     8.20306381241523, 8.19486440761638, 8.18660678154918, 8.17829099726285, 8.16991711837741, 8.16148520908378,
     8.15299533414363, 8.14444755888954, 8.13584194922486, 8.12717857162381, 8.11845749313143, 8.1096787813636,
     8.10084250450701, 8.0919487313192, 8.08299753112856, 8.07398897383427, 8.06492312990638, 8.05580007038575,
     8.04661986688409, 8.03827076758144, 8.0334221209855, 8.02852443017122, 8.02357772604049, 8.01858203990465,
     8.01353740348457, 8.00844384891055, 8.00330140872238, 7.99811011586934, 7.99287000371016, 7.98758110601307,
     7.98224345695577, 7.97685709112543, 7.9714220435187, 7.96593834954171, 7.96040604501006, 7.95482516614883,
     7.94919574959258, 7.94351783238534, 7.93779145198062, 7.9320166462414, 7.92619345344015, 7.92032191225881,
     7.91440206178878, 7.90843394153097, 7.90241759139573, 7.89635305170291, 7.89024036318184, 7.8840795669713,
     7.87787070461958, 7.87161381808441, 7.86530894973304, 7.85895614234215, 7.85255543909793, 7.84610688359603,
     7.83961051984159, 7.8330663922492, 7.82647454564297, 7.81983502525644, 7.81314787673265, 7.80641314612412,
     7.79963087989285, 7.79280112491028, 7.78592392845736, 7.77899933822453, 7.77202740231167, 7.76500816922815,
     7.75794168789282, 7.750828007634, 7.74366717818951, 7.7364592497066, 7.72931033004268, 7.72306909510339,
     7.71678120394977, 7.71044668994934, 7.70406558682744, 7.69763792866719, 7.69116374990953, 7.68464308535319,
     7.6780759701547, 7.67146243982841, 7.66480253024644, 7.65809627763874, 7.65134371859306, 7.64454489005493,
     7.63769982932771, 7.63080857407253, 7.62387116230834, 7.61688763241191, 7.60985802311778, 7.60278237351829,
     7.59566072306362, 7.58849311156171, 7.58127957917833, 7.57402016643703, 7.56671491421918, 7.55936386376395,
     7.55196705666828, 7.54452453488697, 7.53703634073257, 7.52950251687545, 7.52192310634379, 7.51429815252357,
     7.50662769915855, 7.49891179035031, 7.49115047055824, 7.48334378459952, 7.47549177764912, 7.46759449523984,
     7.45965198326225, 7.45166428796475, 7.44363145595353, 7.43555353419257, 7.42743057000368, 7.41926261106644,
     7.41104970541825, 7.40279190145431, 7.39448924792762, 7.38614179394898, 7.37774958898699, 7.36931268286806,
     7.3608311257764, 7.35230496825401, 7.35230496825401, 7.35086804403669, 7.34940024090286, 7.34790156760882,
     7.34637203310516, 7.34481164653679, 7.34322041724286, 7.34159835475686, 7.33994546880655, 7.33826176931397,
     7.33654726639546, 7.33480197036166, 7.33302589171748, 7.33121904116212, 7.3293814295891, 7.32751306808621,
     7.32561396793552, 7.3236841406134, 7.32172359779052, 7.31973235133182, 7.31771041329655, 7.31565779593823,
     7.3135745117047, 7.31146057323806, 7.30931599337471, 7.30714078514536, 7.30493496177496, 7.30269853668281,
     7.30043152348246, 7.29813393598176, 7.29580578818287, 7.29384456011052, 7.29262545366344, 7.29137746740456,
     7.29010060647822, 7.28879487619284, 7.28746028202094, 7.28609682959905, 7.28470452472782, 7.28328337337193,
     7.28183338166014, 7.28035455588528, 7.27884690250423, 7.27731042813797, 7.2757451395715, 7.27415104375393,
     7.2725281477984, 7.27087645898215, 7.26919598474645, 7.26748673269668, 7.26574871060225, 7.26398192639664,
     7.26218638817743, 7.26036210420621, 7.25850908290869, 7.25662733287462, 7.25471686285782, 7.25277768177618,
     7.25080979871164, 7.24881322291023, 7.24678796378204, 7.24473403090121, 7.24265143400598, 7.24054018299861,
     7.23840028794546, 7.23623175907696, 7.23403460678758, 7.23180884163588, 7.22955447434447, 7.22727151580004,
     7.22495997705333, 7.22261986931916, 7.22025120397642, 7.21785399256805, 7.21542824680107, 7.21297397854655,
     7.21049119983966, 7.20797992287959, 7.20544016002964, 7.20287192381714, 7.20027522693352, 7.19765008223425,
     7.19499650273887, 7.19231450163101, 7.18960409225833, 7.18686528813259, 7.18409810292959, 7.18130255048922,
     7.17847864481541, 7.17562640007618, 7.1727458306036, 7.16983695089382, 7.16689977560704, 7.16393431956755,
     7.16094059776368, 7.15791862534785, 7.15486841763653, 7.15178999011025, 7.14868335841363, 7.14554853835535,
     7.14238554590813, 7.1391943972088, 7.13597510855821, 7.13272769642132, 7.12945217742712, 7.12614856836869,
     7.12281688620317, 7.11945714805177, 7.11606937119974, 7.11265357309644, 7.10920977135526, 7.10573798375368,
     7.10223822823324, 7.09871052289953, 7.09515488602222, 7.09157133603506, 7.08795989153583, 7.08432057128642,
     7.08065339421276, 7.07695837940484, 7.07323554611674, 7.06948491376658, 7.06570650193658, 7.06190033037299,
     7.05806641898615, 7.05420478785046, 7.05031545720439, 7.04639844745045, 7.04263837011018, 7.03940478458202,
     7.0361441476462, 7.0328564732741, 7.02954177558308, 7.02620006883645, 7.02283136744349, 7.01943568595944,
     7.0160130390855, 7.01256344166884, 7.0090869087026, 7.00558345532586, 7.0020530968237, 6.99849584862713,
     6.99491172631314, 6.99130074560469, 6.98766292237069, 6.98399827262601, 6.9803068125315, 6.97658855839397,
     6.97284352666618, 6.96907173394687, 6.96527319698075, 6.96144793265846, 6.95759595801663, 6.95371729023787,
     6.94981194665071, 6.94587994472967, 6.94192130209524, 6.93793603651385, 6.93392416589793, 6.92988570830583,
     6.9258206819419, 6.92173969179467, 6.91792414452355, 6.91408224820386, 6.91021401857095, 6.90631947149878,
     6.90239862299993, 6.89845148922566, 6.89447808646579, 6.89047843114881, 6.88645253984185, 6.88240042925062,
     6.87832211621951, 6.87421761773152, 6.87008695090826, 6.86593013300999, 6.8617471814356, 6.8575381137226,
     6.85330294754714, 6.84904170072397, 6.84475439120651, 6.84044103708679, 6.83610165659545, 6.83173626810179,
     6.82734489011372, 6.82292754127779, 6.81848424037917, 6.81401500634166, 6.80951985822769, 6.80499881523832,
     6.80072778848216, 6.79645177128632, 6.79215001778036, 6.78782254458825, 6.78346936846547, 6.77909050629896,
     6.77468597510718, 6.77025579204004, 6.76579997437893, 6.76131853953675, 6.75681150505785, 6.75227888861808,
     6.74772070802478, 6.74313698121674, 6.73852772626428, 6.73654700546688, 6.73631593825652, 6.73606661076776,
     6.73579902399009, 6.73551317898718, 6.73520907689691, 6.73488671893137, 6.73454610637682, 6.73418724059377,
     6.7338101230169, 6.73341475515511, 6.73300113859149, 6.73256927498334, 6.73211916606216, 6.73165081363365,
     6.73116421957773, 6.7306593858485, 6.73013631447428, 6.72959500755757, 6.72903546727511, 6.72850376232357,
     6.72819592381764, 6.72787028281179, 6.72752684048698, 6.72716559809451, 6.72678655695604, 6.72638971846359,
     6.72597508407955, 6.72554265533663, 6.72509243383795, 6.72462442125693, 6.7241386193374, 6.72363502989352,
     6.7231136548098, 6.72257449604113, 6.72201755561274, 6.72144283562023, 6.72085033822955, 6.720240065677,
     6.71961202026926, 6.71896620438335, 6.71830262046665, 6.71762127103689, 6.71692215868217, 6.71620528606095,
     6.71547065590205, 6.71471827100461, 6.71394813423818, 6.71316024854263, 6.71235461692822, 6.71153124247552,
     6.71078118016358, 6.71010461758206, 6.70941056693962, 6.70869903074296, 6.70797001156673, 6.70722351205358,
     6.70645953491413, 6.70567808292695, 6.70487915893864, 6.70406276586373, 6.70322890668477, 6.70237758445225,
     6.70150880228467, 6.70073988847248, 6.69999820490207, 6.69923928044146, 6.69846311770692, 6.69766971938056,
     6.6968590882104, 6.69603122701035, 6.69518613866017, 6.69432382610553, 6.69344429235798, 6.69254754049492,
     6.69163357365968, 6.69070239506143, 6.68975400797524, 6.68878841574207, 6.68780562176874, 6.68680562952797,
     6.68578844255836, 6.68475406446437, 6.68370249891637, 6.6826337496506, 6.68154782046919, 6.68044471524012,
     6.67932443789729, 6.67818699244047, 6.6770323829353, 6.67586061351331, 6.67467168837192, 6.67366258060403,
     6.6727573535396, 6.67183535891044, 6.67089659959912, 6.66994107855005, 6.66896879876945, 6.66797976332542,
     6.66697397534787, 6.66595143802855, 6.66491215462104, 6.66385612844079, 6.66278336286504, 6.66169386133291,
     6.66058762734532, 6.65946466446507, 6.65832497631675, 6.65716856658683, 6.65599543902358, 6.65480559743714,
     6.65359904569946, 6.65237578774435, 6.65113582756743, 6.64987916922619, 6.64860581683994, 6.64731577458981,
     6.64600904671881, 6.64468563753175, 6.64334555139528, 6.64198879273792, 6.64061536604999, 6.63922527588366,
     6.63781852685294, 6.63639512363368, 6.63495507096355, 6.63349837364209, 6.63202503653065, 6.63053506455242,
     6.62902846269244, 6.62750523599756, 6.62596538957651, 6.62440892859982, 6.62283585829988, 6.6212461839709,
     6.61963991096893, 6.61801704471188, 6.61637759067947, 6.61472155441326, 6.61304894151666, 6.61135975765491,
     6.60965400855509, 6.60793170000612, 6.60619283785875, 6.60443742802557, 6.602665476481, 6.60087698926131,
     6.59907197246461, 6.59737754391416, 6.59584972500408, 6.59430569180106, 6.59274544899525, 6.59116900133485,
     6.58957635362601, 6.58796751073294, 6.58634247757783, 6.58470125914087, 6.58304386046027, 6.58137028663227,
     6.57968054281107, 6.5779746342089, 6.57625256609602, 6.57451434380065, 6.57275997270906, 6.57098945826551,
     6.56920280597226, 6.5674000213896, 6.56558111013579, 6.56374607788713, 6.56189493037792, 6.56002767340047,
     6.55814431280508, 6.55624485450008, 6.55432930445178, 6.55239766868453, 6.55044995328067, 6.54848616438054,
     6.5465063081825, 6.54451039094291, 6.54263845162274, 6.54079727812022, 6.53894021788672, 6.53706727637448,
     6.53517845909152, 6.53327377160155, 6.53135321952403, 6.52941680853416, 6.52746454436287, 6.52549643279682,
     6.5235124796784, 6.52151269090573, 6.51949707243267, 6.51746563026882, 6.51541837047949, 6.51335529918574,
     6.51127642256437, 6.50918174684789, 6.50707127832455, 6.50494502333836, 6.50280298828902, 6.500645179632,
     6.49847160387847, 6.49628226759535, 6.49407717740531, 6.49254504124211, 6.49375483835891, 6.49495367552497,
     6.49614154933463, 6.49731845640961, 6.49848439339901, 6.49963935697927, 6.50078334385421, 6.50191635075501,
     6.50303837444023, 6.50414941169577, 6.50524945933491, 6.5063385141983, 6.50741657315395, 6.50848363309724,
     6.50953969095089, 6.51058474366503, 6.51161878821712, 6.512641821612, 6.51365384088187, 6.51465484308631,
     6.51564482531223, 6.51662378467395, 6.51759171831314, 6.5185486233988, 6.51949449712736, 6.52054697502682,
     6.52165201106733, 6.52274631188783, 6.52382987451265, 6.52490269599243, 6.52596477340407, 6.52701610385075,
     6.52805668446194, 6.52908651239339, 6.53010558482711, 6.53111389897141, 6.53211145206087, 6.53309824135635,
     6.53407426414499, 6.53503951774021, 6.53599399948172, 6.53693770673549, 6.53787063689377, 6.53879278737511,
     6.53970415562433, 6.54060473911251, 6.54149453533703, 6.54237354182156, 6.54324175611602, 6.54409917579662,
     6.54494579846587, 6.54578162175253, 6.54660664331165, 6.54742086082457, 6.5482242719989, 6.54901687456852,
     6.5497986662936, 6.5505696449606, 6.55139604652416, 6.5522978393146, 6.55318905651928, 6.55406969577729,
     6.55493975475309, 6.55579923113657, 6.55664812264298, 6.55748642701297, 6.55831414201256, 6.55913126543319,
     6.55993779509168, 6.56073372883023, 6.56151906451644, 6.5622938000433, 6.56305793332917, 6.56381146231784,
     6.56455438497845, 6.56528669930556, 6.56614517705914, 6.56710524913457, 6.56805509478423, 6.56899471167833,
     6.56992409751107, 6.5708432500006, 6.57175216688904, 6.57265084594245, 6.57353928495084, 6.57441748172822,
     6.57528543411251, 6.57614313996563, 6.57699059717341, 6.57782780364569, 6.57865475731623, 6.57947145614277,
     6.580277898107, 6.58107408121456, 6.58186000349506, 6.58263566300207, 6.5834010578131, 6.58415618602965,
     6.58490104577714, 6.58563563520497, 6.5863599524865, 6.58707399581905, ]
)
